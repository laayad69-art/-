<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clean Mind â€” ÙƒØ§Ù…Ù„ (Ø°ÙƒØ±ÙŠØ§ØªØŒ Ø§Ø³ØªØ¹Ø§Ø¯Ø©ØŒ Ø¥Ø±Ø´Ø§Ø¯)</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-dark:#070809;
    --panel: rgba(255,255,255,0.03);
    --muted:#9aa4b2;
    --fire1:#ff5f3d;
    --fire2:#ff9a3d;
    --gold:#ffd166;
    --accent:#00e0b8;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Cairo",sans-serif;background:
    radial-gradient(900px 450px at 8% 8%, rgba(255,93,93,0.04), transparent),
    linear-gradient(180deg,var(--bg-dark),#0b0b0d); color:#fff; -webkit-font-smoothing:antialiased;}
  .app {min-height:100vh; display:flex; flex-direction:column; align-items:stretch;}
  header.appbar {display:flex; align-items:center; justify-content:space-between; padding:12px 18px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border-bottom:1px solid rgba(255,255,255,0.02); position:sticky; top:0; z-index:60;}
  .brand {display:flex; gap:12px; align-items:center}
  .logo {width:56px;height:56px;border-radius:12px;display:grid;place-items:center;font-weight:900;color:#111;background:linear-gradient(135deg,var(--fire1),#7c3aed);box-shadow:0 12px 36px rgba(0,0,0,0.6); font-size:20px; background-size:cover; background-position:center}
  .app-title {font-size:18px; margin:0}
  .user-greet {font-size:13px;color:var(--muted); margin-top:2px; display:flex; gap:8px; align-items:center}
  .user-name {color:var(--accent); font-weight:800}
  nav {display:flex; gap:8px; align-items:center}
  nav button {background:transparent;border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700}
  nav button.active {background:linear-gradient(90deg,var(--fire1),var(--fire2)); color:#100; border:none; box-shadow:0 10px 28px rgba(255,90,60,0.12)}
  .main {display:grid; grid-template-columns:360px 1fr; gap:22px; padding:20px; align-items:start; max-width:1200px; margin:20px auto; width:100%}
  @media(max-width:980px){ .main{grid-template-columns:1fr; padding:12px} nav{flex-wrap:wrap} }
  .panel {background:var(--panel); padding:16px; border-radius:12px; box-shadow:0 16px 48px rgba(0,0,0,0.6);}
  .streak-box {display:flex; gap:12px; align-items:center}
  .fire-circle {width:110px;height:110px;border-radius:999px;display:grid;place-items:center;position:relative; box-shadow:0 18px 50px rgba(0,0,0,0.6); background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.03), transparent);}
  .flame-core {width:70px;height:70px;border-radius:999px; background:
    radial-gradient(circle at 30% 30%, var(--fire2), transparent 30%),
    radial-gradient(circle at 70% 70%, var(--fire1), transparent 35%); filter:blur(6px); animation:burn 1.4s infinite linear;}
  @keyframes burn{0%{transform:translateY(0) scale(1)}50%{transform:translateY(-6px) scale(1.03)}100%{transform:translateY(0) scale(1)}}
  .streak-stats h2{margin:0;font-size:30px}
  .streak-stats p{margin:6px 0 0;color:var(--muted); font-size:12px}
  .controls {margin-top:12px; display:flex; gap:8px; flex-wrap:wrap}
  .btn {padding:9px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:800}
  .btn-primary {background:linear-gradient(90deg,var(--fire1),var(--fire2)); color:#100}
  .btn-ghost {background:transparent;border:1px solid rgba(255,255,255,0.04); color:var(--muted); font-weight:700}
  .small {font-size:13px;color:var(--muted); margin-top:10px}
  .content {display:flex; flex-direction:column; gap:14px}
  .hero {padding:14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02))}
  .quote {color:var(--muted); margin-top:6px}
  .xp-row {display:flex; align-items:center; gap:12px; margin-top:12px}
  .xp-bar {flex:1; background:rgba(255,255,255,0.04); border-radius:10px; overflow:hidden; height:14px; position:relative}
  .xp-fill {height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--gold)); transition:width .6s ease}
  .xp-meta {font-size:13px; color:var(--muted); min-width:160px; text-align:left}
  .badges {display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
  .badge {padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.02); font-weight:700; font-size:13px; color:var(--muted); border:1px solid rgba(255,255,255,0.02)}
  .badge.earned {background:linear-gradient(90deg,var(--gold),#ffd27a); color:#120; box-shadow:0 10px 30px rgba(255,200,50,0.06)}
  .modal {position:fixed; inset:0; display:grid; place-items:center; background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.85)); z-index:80; visibility:hidden; opacity:0; transition:all .28s ease}
  .modal.show{visibility:visible; opacity:1}
  .modal .card {width:92%; max-width:520px; padding:18px;border-radius:12px; text-align:center; background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(0,0,0,0.03)); box-shadow:0 40px 100px rgba(0,0,0,0.8)}
  #confettiCanvas{position:fixed; inset:0; pointer-events:none; z-index:85; display:none}
  .fade-in { animation:fadeUp .7s ease both; }
  @keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }

  /* Memories UI */
  .memories-list { max-height:420px; overflow:auto; margin-top:10px; padding-right:6px }
  .memory-item { padding:10px; border-radius:10px; background:rgba(255,255,255,0.02); margin-bottom:8px; border:1px solid rgba(255,255,255,0.03) }
  .memory-meta { color:var(--muted); font-size:12px; margin-bottom:6px }
  .mood { padding:4px 8px; border-radius:8px; font-weight:700; font-size:12px; display:inline-block; margin-left:6px }
  .mood.happy { background:rgba(0,200,150,0.12); color:#00e0b8 }
  .mood.neutral { background:rgba(255,255,255,0.03); color:var(--muted) }
  .mood.sad { background:rgba(255,80,80,0.08); color:#ff6b6b }
  .mem-actions { margin-top:8px; display:flex; gap:8px; justify-content:flex-end }
  .qa-box { margin-top:12px; padding:12px; border-radius:10px; background:rgba(255,255,255,0.02) }
  input, textarea, select { font-family:inherit; color:inherit; background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px; border-radius:8px; width:100% }
  textarea { min-height:80px; resize:vertical }

  /* ranks grid */
  .ranks-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:12px; margin-top:12px }
  .rank-card { padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); box-shadow:0 10px 30px rgba(0,0,0,0.5); position:relative }
  .rank-card.highlight { outline:3px solid rgba(255,215,102,0.08); transform:translateY(-6px) }

  /* settings logos */
  .settings-row { display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap }
  .logo-preview { width:64px; height:64px; border-radius:10px; background:linear-gradient(135deg,var(--fire1),var(--fire2)); display:grid; place-items:center; font-weight:900; color:#111; box-shadow:0 6px 18px rgba(0,0,0,0.6); background-size:cover; background-position:center }
</style>
</head>
<body>
<div class="app" id="appRoot">
  <header class="appbar fade-in" role="banner">
    <div class="brand" aria-hidden="false">
      <div class="logo" id="logoEl">CM</div>
      <div>
        <div class="app-title">Clean Mind</div>
        <div class="user-greet" id="headerGreet">
          <div class="user-prefix" id="headerPrefix">Ø£Ù‡Ù„Ø§Ù‹</div>
          <div class="user-name" id="headerName">Ø¨Ùƒ</div>
          <div style="font-size:12px;color:var(--muted);margin-right:8px" id="headerTitle"></div>
        </div>
      </div>
    </div>
    <nav role="navigation" aria-label="Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…">
      <button id="navChallenge" class="active" onclick="showTab('challenge')">Ø§Ù„ØªØ­Ø¯ÙŠ</button>
      <button id="navRanks" onclick="showTab('ranks')">Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨</button>
      <button id="navStats" onclick="showTab('stats')">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
      <button id="navMemories" onclick="showTab('memories')">Ø°ÙƒØ±ÙŠØ§Øª</button>
      <button id="navGuide" onclick="showTab('guide')">ğŸ“˜ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯</button>
      <button id="navSettings" onclick="showTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </nav>
  </header>

  <main class="main fade-in" role="main" aria-live="polite">
    <!-- LEFT PANEL -->
    <aside class="panel" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…">
      <div class="streak-box">
        <div class="fire-circle" aria-hidden="true"><div class="flame-core" id="flameCore"></div></div>
        <div class="streak-stats">
          <h2 id="daysDisplay">0</h2>
          <p id="streakSub">Ø£ÙŠØ§Ù… Ø¯ÙˆÙ† Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ©</p>
        </div>
      </div>

      <div style="margin-top:12px">
        <div id="timeDisplay" style="font-weight:800; font-size:14px">Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯</div>
        <div class="small">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ â€” Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„Ø°ÙƒØ±ÙŠØ§Øª Ù…ØªØ§Ø­Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§</div>
      </div>

      <div class="xp-row">
        <div class="xp-meta" id="xpMeta">XP: 0 â€¢ Ù…Ø³ØªÙˆÙ‰ 1</div>
        <div class="xp-bar" title="ØªÙ‚Ø¯Ù‘Ù… Ø§Ù„Ù€ XP">
          <div class="xp-fill" id="xpFill"></div>
        </div>
      </div>

      <div class="badges" id="badgeList" aria-live="polite" style="margin-top:8px"></div>

      <div class="controls">
        <button class="btn btn-primary" id="btnStartResume" onclick="startOrResume()">Ø§Ø¨Ø¯Ø£ / Ø§Ø³ØªØ£Ù†Ù</button>
        <button class="btn btn-ghost" id="btnPause" onclick="togglePause()">Ø£ÙˆÙ‚Ù Ù…Ø¤Ù‚ØªÙ‹Ø§</button>
        <button class="btn btn-ghost" onclick="promptSetName(true)">ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù…</button>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn btn-ghost" id="btnRestore" onclick="attemptOfferRestore()">Ø§Ø³ØªØ¹Ø§Ø¯Ø© ğŸ”</button>
        <div style="display:flex; flex-direction:column; justify-content:center">
          <div class="small">ÙØ±Øµ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <strong id="recoveriesLeft">3</strong></div>
          <div class="small">Ø£Ù‚Ø±Ø¨ ØªØ§Ø±ÙŠØ® Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: <span id="nextRestoreDate">--</span></div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn btn-ghost" onclick="createMomentMemory()">Ø§Ø¶Ù Ø°Ø§ÙƒØ±Ø© Ù„Ø­Ø¸ÙŠØ©</button>
        <button class="btn btn-ghost" onclick="openMemoriesPanel()">Ø¹Ø±Ø¶ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</button>
      </div>
    </aside>

    <!-- RIGHT CONTENT -->
    <section class="content">
      <!-- CHALLENGE -->
      <div id="challenge" class="panel hero" role="region" aria-label="Ø§Ù„ØªØ­Ø¯ÙŠ">
        <h3 id="welcomeTitle">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Clean Mind</h3>
        <div class="quote" id="dailyQuote">ÙƒÙ„ ÙŠÙˆÙ… Ø¨Ø¯ÙˆÙ† Ù…Ø­ØªÙˆÙ‰ Ù…Ø­Ø¸ÙˆØ± Ù‡Ùˆ Ø§Ù†ØªØµØ§Ø± â€” Ø§Ø¨Ø¯Ø£ Ø¨Ø®Ø·ÙˆØ© Ø¨Ø³ÙŠØ·Ø© Ø§Ù„Ø¢Ù†.</div>

        <div style="display:flex; gap:12px; margin-top:14px; align-items:center; flex-wrap:wrap;">
          <div style="flex:1">
            <div style="font-size:13px;color:var(--muted)">Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…</div>
            <div id="todayGoal" style="margin-top:8px;color:#fff">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø¯Ù Ù…Ø­Ø¯Ø¯.</div>
            <div style="margin-top:8px; display:flex; gap:8px">
              <button class="btn btn-ghost" onclick="setGoal()">ØªØ¹ÙŠÙŠÙ† Ù‡Ø¯Ù</button>
              <button class="btn btn-ghost" onclick="clearGoal()">Ù…Ø³Ø­ Ø§Ù„Ù‡Ø¯Ù</button>
            </div>

            <div style="margin-top:10px">
              <h4 style="margin:8px 0 4px">Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©</h4>
              <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
                <button class="btn btn-ghost" onclick="doBreath()">ØªÙ…Ø§Ø±ÙŠÙ† ØªÙ†ÙÙ‘Ø³</button>
                <button class="btn btn-ghost" onclick="doDistract()">Ø®Ø·Ø© Ø¥Ù„Ù‡Ø§Ø¡</button>
                <button class="btn btn-ghost" onclick="openCelebration()">Ø§Ø­ØªÙØ§Ù„ Ø§Ù„Ø¢Ù†</button>
              </div>
            </div>
          </div>

          <div style="width:320px">
            <div style="font-size:13px;color:var(--muted)">Ù…Ø±Ø§Ù‚Ø¨Ø© ÙŠÙˆÙ…ÙŠØ©</div>
            <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
              <div style="flex:1">
                <div style="font-size:13px;color:var(--muted)">Ø£Ø¯Ø®Ù„ Ø´Ø¹ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†</div>
                <select id="quickMood" style="margin-top:6px; width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06)"><option value="">-- Ø§Ø®ØªØ± --</option><option value="happy">ğŸ˜Š Ø³Ø¹ÙŠØ¯</option><option value="neutral">ğŸ˜ Ù…Ø­Ø§ÙŠØ¯</option><option value="sad">ğŸ˜” Ø­Ø²ÙŠÙ†</option></select>
              </div>
              <div>
                <button class="btn btn-primary" onclick="saveQuickMood()">Ø­ÙØ¸</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <div style="font-size:13px;color:var(--muted)">Ø³Ø¬Ù„ Ø³Ø±ÙŠØ¹</div>
              <div style="margin-top:8px"><input id="quickNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ø±ÙŠØ¹Ø©..." /></div>
              <div style="margin-top:8px"><button class="btn btn-ghost" onclick="saveQuickNote()">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button></div>
            </div>
          </div>
        </div>
      </div>

      <!-- RANKS -->
      <div id="ranks" class="panel" style="display:none" role="region" aria-label="Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨">
        <h3>Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨</h3>
        <div id="currentRankBox" style="margin-top:10px"></div>
        <div class="ranks-grid" id="ranksGrid"></div>
      </div>

      <!-- STATS -->
      <div id="stats" class="panel" style="display:none" role="region" aria-label="Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">
        <h3>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <div style="margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px">
          <div class="panel" style="padding:10px">
            <div style="color:var(--muted)">Ø£ÙŠØ§Ù… Ø§Ù„Ù†Ù‚Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
            <div style="font-weight:800;font-size:18px" id="statCurrent">0</div>
          </div>
          <div class="panel" style="padding:10px">
            <div style="color:var(--muted)">Ø£Ø·ÙˆÙ„ Ø³ØªØ±ÙŠÙƒ</div>
            <div style="font-weight:800;font-size:18px" id="statBest">0</div>
          </div>
          <div class="panel" style="padding:10px">
            <div style="color:var(--muted)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù†Ø¸ÙŠÙØ©</div>
            <div style="font-weight:800;font-size:18px" id="statTotal">0</div>
          </div>
          <div class="panel" style="padding:10px">
            <div style="color:var(--muted)">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù†ØªÙƒØ§Ø³Ø§Øª</div>
            <div style="font-weight:800;font-size:18px" id="statRelapses">0</div>
          </div>
        </div>
      </div>

      <!-- MEMORIES -->
      <div id="memories" class="panel" style="display:none" role="region" aria-label="Ø°ÙƒØ±ÙŠØ§Øª Ø§Ù„ØªØ­Ø¯ÙŠ">
        <h3>Ø°ÙƒØ±ÙŠØ§Øª Ø§Ù„ØªØ­Ø¯ÙŠ</h3>
        <div style="display:flex; gap:12px; margin-top:10px; align-items:flex-start; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px">
            <label style="display:block;margin-bottom:6px;color:var(--muted)">Ø£Ø¶Ù Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø©</label>
            <input id="memTag" placeholder="ÙˆØ³Ù… (Ù…Ø«Ù„Ø§Ù‹: Ù†Ø¬Ø§Ø­ØŒ Ù…Ø­Ù†Ø©)" />
            <select id="memMood" style="margin-top:8px">
              <option value="happy">ğŸ˜Š Ø³Ø¹ÙŠØ¯</option>
              <option value="neutral">ğŸ˜ Ù…Ø­Ø§ÙŠØ¯</option>
              <option value="sad">ğŸ˜” Ø­Ø²ÙŠÙ†</option>
            </select>
            <textarea id="memText" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø¹Ù† ÙŠÙˆÙ…Ùƒ Ø£Ùˆ Ø§Ù„ØªØ­Ø¯ÙŠ..." style="margin-top:8px"></textarea>
            <div style="display:flex; gap:8px; margin-top:8px">
              <button class="btn btn-primary" onclick="addMemory()">Ø­ÙØ¸ Ø§Ù„Ø°ÙƒØ±Ù‰</button>
              <button class="btn btn-ghost" onclick="clearMemoryForm()">Ø¥ÙØ±Ø§Øº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
            </div>
            <div style="margin-top:12px">
              <button class="btn btn-ghost" onclick="exportMemories()">ØªØµØ¯ÙŠØ± Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</button>
              <button class="btn btn-ghost" onclick="importMemories()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø°ÙƒØ±ÙŠØ§Øª</button>
              <button class="btn btn-ghost" onclick="clearAllMemories()">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</button>
            </div>
          </div>

          <div style="flex:1.2; min-width:320px">
            <label style="display:block;margin-bottom:6px;color:var(--muted)">Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</label>
            <div class="memories-list" id="memoriesList"></div>
          </div>
        </div>

        <div style="margin-top:12px" class="qa-box">
          <h4 style="margin:0 0 8px">Ø§Ø³Ø£Ù„ Ø§Ù„Ù…Ø¯Ø±Ø¨</h4>
          <input id="qaInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ (Ù…Ø«Ù„Ø§Ù‹: ÙƒÙŠÙ Ø£ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±ØºØ¨Ø©ØŸ)" />
          <div style="margin-top:8px; display:flex; gap:8px">
            <button class="btn btn-primary" onclick="askCoach()">Ø§Ø³Ø£Ù„</button>
            <button class="btn btn-ghost" onclick="clearQA()">Ø¥ÙØ±Ø§Øº</button>
          </div>
          <div id="qaResponse" style="margin-top:8px;color:var(--accent); font-weight:700"></div>
        </div>
      </div>

      <!-- GUIDE -->
      <div id="guide" class="panel" style="display:none" role="region" aria-label="ØµÙØ­Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯">
        <h3>Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ â€” Ø¯Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹</h3>
        <div style="margin-top:10px">
          <ol style="color:var(--muted); line-height:1.7">
            <li>Ø§Ø¨Ø¯Ø£ Ø¨ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù…Ùƒ Ø«Ù… Ø§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£.</li>
            <li>Ø§Ø¶Ø¨Ø· Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ù„Ù‡Ø§Ø¡ ÙˆØ§Ù„ØªÙ†ÙØ³ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.</li>
            <li>Ø³Ø¬Ù„ Ø°ÙƒØ±ÙŠØ§ØªÙƒ ÙˆÙ…Ø²Ø§Ø¬Ùƒ â€” Ù‡Ø°Ø§ ÙŠØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†.</li>
            <li>Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¨Ø­Ø§Ø¬Ø© Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³ØªØ±ÙŠÙƒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (ØªØªÙˆÙØ± ÙØ±Øµ Ù…Ø­Ø¯ÙˆØ¯Ø©).</li>
          </ol>
          <div style="margin-top:12px">
            <button class="btn btn-primary" onclick="startGuideQuiz()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­ÙÙŠØ²ÙŠ</button>
          </div>

          <div id="guideQuizArea" style="margin-top:12px; display:none">
            <div id="gQuestion" style="font-weight:700"></div>
            <div id="gAnswers" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap"></div>
            <div id="gMessage" style="margin-top:8px;color:var(--accent); font-weight:700"></div>
            <div style="margin-top:10px"><button class="btn btn-ghost" onclick="finishGuide()">Ø£Ù†Ù‡ÙŠ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ ÙˆØ¹Ø¯ Ù„Ù„ØªØ­Ø¯ÙŠ</button></div>
          </div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div id="settings" class="panel" style="display:none" role="region" aria-label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
        <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <div style="margin-top:8px">
          <label style="display:block;margin-bottom:6px;color:var(--muted)">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</label>
          <select id="notifTime">
            <option value="08:00">â›… ØµØ¨Ø§Ø­ÙŠ -- 08:00</option>
            <option value="22:00">ğŸŒ™ Ù…Ø³Ø§Ø¦ÙŠ -- 22:00</option>
          </select>
        </div>

        <div style="margin-top:12px">
          <label style="display:block;margin-bottom:6px;color:var(--muted)">ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø³Ù‚</label>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button class="btn btn-ghost" onclick="setTheme('default')">Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
            <button class="btn btn-ghost" onclick="setTheme('pink')">ÙˆØ±Ø¯ÙŠ</button>
            <button class="btn btn-ghost" onclick="setTheme('dark')">Ø¯Ø§ÙƒÙ†</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <label style="display:block;margin-bottom:6px;color:var(--muted)">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø±ÙØ¹ ØµÙˆØ±Ø©)</label>
          <div class="settings-row">
            <div class="logo-preview" id="logoPreview">CM</div>
            <div style="flex:1">
              <input type="file" id="logoUpload" accept="image/*" />
              <div style="margin-top:8px; display:flex; gap:8px">
                <button class="btn btn-primary" onclick="applyUploadedLogo()">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø¹Ø§Ø±</button>
                <button class="btn btn-ghost" onclick="removeLogo()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <button class="btn btn-ghost" onclick="exportAllData()">ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button class="btn btn-ghost" onclick="importAllData()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button class="btn btn-ghost" onclick="resetAll()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„ Ø´ÙŠØ¡</button>
        </div>
      </div>

    </section>
  </main>

  <footer class="appfoot">ØªÙ… Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¨ÙˆØ§Ø³Ø·Ø© <strong>Ø¥ÙŠØ§Ø¯ Ø¹Ù„Ø§Ø¡</strong> Ø¨Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ù…Ø¹ <strong>ZMAX</strong> â€” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§</footer>
</div>

<!-- Visit / Set name popup -->
<div class="modal visit-popup" id="visitModal" role="dialog" aria-hidden="true">
  <div class="card">
    <h2 style="margin:0 0 8px">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Clean Mind ğŸ‘‹</h2>
    <p style="color:var(--muted)">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù„ÙŠ ØªØ­Ø¨ Ù†Ù†Ø§Ø¯ÙŠÙƒ Ø¨ÙŠÙ‡.</p>
    <div style="margin-top:8px; display:flex; gap:8px; justify-content:center">
      <input id="nameField" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ø³ØªØ¹Ø§Ø±" maxlength="24" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff" />
      <button class="btn btn-primary" onclick="saveNameFromPopup()">Ø­ÙØ¸ ÙˆØ§Ø¨Ø¯Ø£</button>
    </div>
    <div style="margin-top:12px; display:flex; gap:10px; justify-content:center">
      <button class="btn btn-ghost" onclick="skipVisitPopup()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø¢Ù†</button>
      <button class="btn btn-ghost" onclick="dontShowPopupAgain()">Ù„Ø§ ØªØ¸Ù‡Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
    </div>
  </div>
</div>

<!-- Celebration modal -->
<div class="modal" id="celebrationModal" role="dialog" aria-hidden="true">
  <div class="card">
    <div class="celebration-gold" id="celebrationTitle" style="font-size:28px;color:var(--gold)">ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!</div>
    <div id="celebrationText" style="margin-top:12px;color:#fff; opacity:0.95">Ø¥Ù†Ø¬Ø§Ø² Ø±Ø§Ø¦Ø¹.</div>
    <div style="margin-top:12px">
      <button class="btn btn-primary" onclick="closeCelebration()">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>
</div>

<canvas id="confettiCanvas"></canvas>
<div id="xpToastRoot" style="display:none"></div>

<script>
/* ---------------------------
   App logic (improvements / fixes requested)
   --------------------------- */

/* storage keys */
const KEY = 'cleanmind_v3_pro_xp';
const NAME_KEY = 'cleanmind_v3_name';
const VISIT_KEY = 'cleanmind_v3_first_visit_shown';
const MEM_KEY = 'cleanmind_memories_v1';
const LOGO_KEY = 'cleanmind_logo_v1';

/* default state */
const DEFAULT = {
  started:false, startTime:null, prevStartTime:null, paused:false, pauseTime:null,
  gender:'male', recoveriesLeft:3, relapseCount:0, lastRelapse:null, bestStreakDays:0,
  totalDaysAccum:0, logs:[], goal:'', notifEnabled:false, notifTime:'08:00', lastTick: Date.now(),
  day3Shown:false, celebratedWeeks:[], lastNotifKey:null,
  xp:0, level:1, badges:[], rewardLog:[], lastXPGrantDate:null, xpPerDay:10
};

/* load/save */
function loadState(){ try{ const raw = localStorage.getItem(KEY); if(!raw) return {...DEFAULT}; return {...DEFAULT, ...JSON.parse(raw)}; }catch(e){ console.error(e); return {...DEFAULT}; } }
function saveState(){ state.lastTick = Date.now(); try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){console.error('save err',e)} }
function loadName(){ try{ return localStorage.getItem(NAME_KEY) || ''; }catch(e){return '';} }
function saveNameLocal(n){ try{ localStorage.setItem(NAME_KEY, n || ''); }catch(e){} }

/* state */
let state = loadState();
state.userName = loadName();

/* memories init */
(function initMemories(){
  if(!localStorage.getItem(MEM_KEY)) localStorage.setItem(MEM_KEY, JSON.stringify([]));
})();

/* helper now, friendlyDuration */
function now(){ return Date.now(); }
function friendlyDuration(ms){
  let s = Math.floor(ms/1000);
  const days = Math.floor(s/(3600*24)); s -= days*3600*24;
  const hours = Math.floor(s/3600); s -= hours*3600;
  const minutes = Math.floor(s/60); s -= minutes*60;
  const seconds = s;
  return {days,hours,minutes,seconds};
}

/* RANKS */
const RANKS = [
  {id:'r1', title:'Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ Ø§Ù„Ù‚ÙˆÙŠ ğŸ’ª', min:0, max:2, desc:'Ø¨Ø¯Ø§ÙŠØ©'},
  {id:'r2', title:'Ø§Ù„Ù…Ø«Ø§Ø¨Ø± ğŸ”¥', min:3, max:6, desc:'Ø«Ø¨Ø§Øª'},
  {id:'r3', title:'Ø§Ù„Ù…Ù‚Ø§ØªÙ„ Ø§Ù„Ù†Ø¸ÙŠÙ âš¡', min:7, max:13, desc:'Ù‚ÙˆØ©'},
  {id:'r4', title:'ØµØ§Ø­Ø¨ Ø§Ù„Ø¥Ø±Ø§Ø¯Ø© Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠØ© âš”ï¸', min:14, max:29, desc:'Ø¥Ø±Ø§Ø¯Ø©'},
  {id:'r5', title:'Ø§Ù„Ù…Ù†ØªØµØ± Ø§Ù„Ø°Ù‡Ø¨ÙŠ ğŸ†', min:30, max:99999, desc:'Ù…Ø³ØªÙˆÙ‰ Ø§Ø­ØªØ±Ø§ÙÙŠ'}
];
function getRankByDays(days){ for(const r of RANKS) if(days>=r.min && days<=r.max) return r; return RANKS[0]; }

/* confetti */
const confettiCanvas = document.getElementById('confettiCanvas');
const confettiCtx = confettiCanvas.getContext && confettiCanvas.getContext('2d');
let confettiParticles = [], confettiRunning = false;
function resizeConfetti(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeConfetti); resizeConfetti();
function spawnConfetti(amount=80){
  if(!confettiCtx) return;
  confettiCanvas.style.display='block';
  confettiParticles = [];
  for(let i=0;i<amount;i++){
    confettiParticles.push({
      x: Math.random()*confettiCanvas.width,
      y: Math.random()*-confettiCanvas.height*0.2,
      vx: (Math.random()-0.5)*6,
      vy: Math.random()*4+2,
      size: Math.random()*8+6,
      rot: Math.random()*360,
      color: `hsl(${Math.floor(Math.random()*360)}, 75%, 60%)`,
      spin: (Math.random()-0.5)*0.2
    });
  }
  if(!confettiRunning) confettiLoop();
}
function confettiLoop(){
  if(!confettiCtx) return;
  confettiRunning = true;
  confettiCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  for(let p of confettiParticles){
    p.x += p.vx; p.y += p.vy; p.vy += 0.06; p.rot += p.spin;
    confettiCtx.save();
    confettiCtx.translate(p.x,p.y);
    confettiCtx.rotate(p.rot);
    confettiCtx.fillStyle = p.color;
    confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
    confettiCtx.restore();
  }
  confettiParticles = confettiParticles.filter(p=>p.y < confettiCanvas.height + 50);
  if(confettiParticles.length>0) requestAnimationFrame(confettiLoop);
  else { confettiRunning = false; confettiCanvas.style.display='none'; }
}

/* Logs/toast */
function showToast(msg, short=true){
  const t = document.createElement('div'); t.className='toast'; t.textContent = msg;
  Object.assign(t.style,{position:'fixed',left:'50%',transform:'translateX(-50%)',bottom:'30px',background:'linear-gradient(90deg,var(--fire1),var(--fire2))',color:'#021',padding:'10px 14px',borderRadius:'10px',zIndex:9999});
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), short?2200:4200);
}

/* XP & badges */
const BADGES = [
  {id:'b_day3', title:'Ø¨Ø±ÙˆÙ†Ø²ÙŠ â€” 3 Ø£ÙŠØ§Ù…', thresholdDays:3},
  {id:'b_day7', title:'ÙØ¶ÙŠ â€” 7 Ø£ÙŠØ§Ù…', thresholdDays:7},
  {id:'b_day14', title:'Ø°Ù‡Ø¨ÙŠ â€” 14 ÙŠÙˆÙ…', thresholdDays:14},
  {id:'b_day30', title:'Ø¨Ù„Ø§Ø·ÙŠÙ†ÙŠ â€” 30 ÙŠÙˆÙ…', thresholdDays:30},
  {id:'b_day100', title:'Ø£Ø³Ø·ÙˆØ±ÙŠ â€” 100 ÙŠÙˆÙ…', thresholdDays:100}
];

function awardBadgeIfNeeded(days){
  for(const b of BADGES){
    if(days >= b.thresholdDays && !state.badges.includes(b.id)){
      state.badges.push(b.id);
      pushRewardLog('badge',{badgeId:b.id, title:b.title});
      pushLog('badge_awarded', b.id);
      saveState();
      showCelebration(`ÙˆØ³Ø§Ù… Ø¬Ø¯ÙŠØ¯: ${b.title}`, '');
    }
  }
}
function pushRewardLog(type, meta){ state.rewardLog = state.rewardLog || []; state.rewardLog.unshift({ts: now(), type, meta}); if(state.rewardLog.length>200) state.rewardLog.length=200; saveState(); }

/* Milestones check (on tick) */
function checkMilestones(){
  if(!state.started || !state.startTime) return;
  const elapsed = (state.paused ? state.pauseTime : now()) - state.startTime;
  const d = friendlyDuration(elapsed).days;

  // daily XP awarding (simple, once per day)
  if(!state.lastXPGrantDate || (new Date(state.lastXPGrantDate).toDateString() !== new Date().toDateString())){
    const elapsedHours = Math.floor(elapsed / (1000*60*60));
    if(elapsedHours >= 1 || d>0){
      const amount = state.xpPerDay || 10;
      state.xp = (state.xp || 0) + amount;
      state.lastXPGrantDate = now();
      pushRewardLog('xp',{amount, reason:`Ù…ÙƒØ§ÙØ£Ø© ${d} ÙŠÙˆÙ…`});
      saveState();
      // optional level up check handled in renderXP
      showToast(`+${amount} XP â€” Ù…ÙƒØ§ÙØ£Ø© ÙŠÙˆÙ…ÙŠØ©`);
    }
  }

  // 3-day milestone
  if(d >= 3 && !state.day3Shown){
    state.day3Shown = true;
    pushLog('milestone_day3');
    saveState();
    showCelebration('Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø«! ğŸ”¥', 'Ù„Ù‚Ø¯ Ø¨Ø¯Ø£Øª ØªØ³ØªØ¹ÙŠØ¯ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø°Ù‡Ù†Ùƒ -- Ø£Ø­Ø³Ù†Øª!');
  }

  // weekly milestones
  const weekIndex = Math.floor(d/7);
  if(weekIndex >=1 && !state.celebratedWeeks.includes(weekIndex)){
    state.celebratedWeeks.push(weekIndex);
    pushLog('milestone_week_'+weekIndex);
    saveState();
    showCelebration(`Ø£Ø³Ø¨ÙˆØ¹ Ù†Ù‚Ø§Ø¡! ğŸ…`, `Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª ${weekIndex*7} ÙŠÙˆÙ…Ù‹Ø§ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø¡ -- Ø§Ø³ØªÙ…Ø±!`);
  }

  // badges
  awardBadgeIfNeeded(d);
}

/* Restore logic */
const RESTORE_WAIT_DAYS = 10;
function daysSinceLastRelapse(){ return state.lastRelapse ? Math.floor((now() - state.lastRelapse)/(1000*60*60*24)) : Infinity; }
function canRestoreNow(){
  if((state.recoveriesLeft || 0) <= 0) return {ok:false, reason:'no-chances'};
  if(!state.lastRelapse) return {ok:false, reason:'no-relapse'};
  const daysSince = daysSinceLastRelapse();
  if(daysSince < RESTORE_WAIT_DAYS) return {ok:false, reason:'wait', daysRemaining: RESTORE_WAIT_DAYS - daysSince};
  return {ok:true};
}
function getNextRestoreDate(){
  if(!state.lastRelapse) return null;
  const next = new Date(state.lastRelapse + RESTORE_WAIT_DAYS*24*60*60*1000);
  return next;
}
function updateRestoreUI(){
  const btn = document.getElementById('btnRestore');
  const info = document.getElementById('nextRestoreDate');
  const can = canRestoreNow();
  if(can.ok){
    btn.classList.remove('disabled');
    btn.disabled = false;
    info.textContent = 'Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†';
  } else {
    btn.classList.add('disabled');
    btn.disabled = true;
    if(can.reason==='no-chances'){ info.textContent = 'Ø§Ù†ØªÙ‡Øª ÙØ±Øµ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©' }
    else if(can.reason==='no-relapse'){ info.textContent = '--' }
    else if(can.reason==='wait'){
      const next = getNextRestoreDate();
      info.textContent = next ? next.toLocaleDateString() : '--';
    } else info.textContent = '--';
  }
}
function attemptOfferRestore(){
  const can = canRestoreNow();
  if(!can.ok){
    if(can.reason==='no-chances'){ showToast('Ø§Ù†ØªÙ‡Øª ÙØ±Øµ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³ØªØ±ÙŠÙƒ'); return; }
    if(can.reason==='wait'){ showToast(`Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¢Ù†. Ø§Ù†ØªØ¸Ø± ${can.daysRemaining} ÙŠÙˆÙ…Ù‹Ø§.`); return; }
    if(can.reason==='no-relapse'){ showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù†ØªÙƒØ§Ø³Ø© Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'); return; }
    return;
  }
  if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³ØªØ±ÙŠÙƒ Ø§Ù„Ø¢Ù†ØŸ Ø³ÙŠÙØ®ØµÙ… Ù…Ù† ÙØ±Øµ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (${state.recoveriesLeft}) ÙˆØ³ÙŠØ¹ÙˆØ¯ Ø§Ù„Ø³ØªØ±ÙŠÙƒ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.`)) return;
  state.recoveriesLeft = Math.max(0, (state.recoveriesLeft||0)-1);
  const restoredStart = state.prevStartTime || (state.lastRelapse ? state.lastRelapse - 1*60*60*1000 : now());
  state.startTime = restoredStart;
  state.started = true;
  state.paused = false;
  state.pauseTime = null;
  pushLog('restore', `recoveriesLeft=${state.recoveriesLeft}`);
  saveState();
  renderAll();
  showCelebration('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³ØªØ±ÙŠÙƒ ğŸ‰', 'Ù„Ù‚Ø¯ Ù†Ù‡Ø¶Øª Ù…Ù† Ø§Ù„Ø±Ù…Ø§Ø¯ â€” Ø§Ø³ØªÙ…Ø±!');
}

/* Start / Pause / Relapse */
function startOrResume(){
  if(!state.started){
    state.started = true;
    state.startTime = now();
    state.prevStartTime = state.startTime;
    state.paused = false;
    state.pauseTime = null;
    pushLog('start');
    showToast('ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ -- Ø¨Ø¯Ø§ÙŠØ© Ù…ÙˆÙÙ‚Ø© ğŸ‘');
    saveState();
    renderAll();
    return;
  }
  if(state.paused){
    state.paused = false;
    const pausedDuration = now() - state.pauseTime;
    state.startTime += pausedDuration;
    state.pauseTime = null;
    pushLog('resume');
    showToast('ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØªØªØ¨Ø¹');
    saveState();
    renderAll();
    return;
  }
  showToast('Ø£Ù†Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠ');
}
function togglePause(){
  if(!state.started){ showToast('Ù„Ù… ØªØ¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ Ø¨Ø¹Ø¯'); return; }
  if(!state.paused){
    state.paused = true;
    state.pauseTime = now();
    pushLog('pause');
    showToast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø¤Ù‚ØªÙ‹Ø§');
  } else {
    startOrResume();
    return;
  }
  saveState(); renderAll();
}
function confirmRelapse(){ if(!state.started){ showToast('Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯'); return; } if(!confirm('ØªØ£ÙƒÙŠØ¯: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ¹Ø±Ø¶Øª Ù„Ø§Ù†ØªÙƒØ§Ø³Ø©ØŸ (Ø³ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ø³ØªØ±ÙŠÙƒ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ±)')) return; handleRelapse(); }
function handleRelapse(){
  const relapseTs = now();
  state.prevStartTime = state.startTime || state.prevStartTime;
  pushLog('relapse');
  state.relapseCount = (state.relapseCount||0) + 1;
  state.lastRelapse = relapseTs;
  if(state.prevStartTime){
    const endTs = state.paused ? state.pauseTime : now();
    const daysThis = Math.floor((endTs - state.prevStartTime)/(1000*60*60*24));
    state.totalDaysAccum = (state.totalDaysAccum||0) + Math.max(0, daysThis);
    if(daysThis > (state.bestStreakDays||0)) state.bestStreakDays = daysThis;
  }
  state.started = false;
  state.startTime = null;
  state.paused = false;
  state.pauseTime = null;
  saveState();
  renderAll();
  showToast('Ø³Ø¬Ù„Øª Ø§Ù„Ø§Ù†ØªÙƒØ§Ø³Ø© â€” Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ù‹Ø§');
}

/* Goal / Tools */
function setGoal(){ const g = prompt('Ø§ÙƒØªØ¨ Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…:', state.goal || ''); if(g===null) return; state.goal = g.trim(); pushLog('set_goal', state.goal); saveState(); renderAll(); }
function clearGoal(){ state.goal=''; pushLog('clear_goal'); saveState(); renderAll(); }
function doBreath(){ alert('ØªÙ…Ø§Ø±ÙŠÙ† ØªÙ†ÙÙ‘Ø³: ØªÙ†ÙØ³ 4 Ø«ÙˆØ§Ù†Ù -- Ø§Ø­Ø¨Ø³ 4 Ø«ÙˆØ§Ù†Ù -- Ø§Ø²ÙØ± 4 Ø«ÙˆØ§Ù†Ù -- ÙƒØ±Ø± 6 Ù…Ø±Ø§Øª.'); }
function doDistract(){ alert('Ø®Ø·Ù‘Ø© Ø¥Ù„Ù‡Ø§Ø¡: Ø§Ø®Ø±Ø¬ Ù„Ù„Ù…Ø´ÙŠ 5 Ø¯Ù‚Ø§Ø¦Ù‚ØŒ Ø§Ø´Ø±Ø¨ Ù…Ø§Ø¡ØŒ Ø§ÙƒØªØ¨ Ù…Ù‡Ù…Ø© ØµØºÙŠØ±Ø© ÙˆØ§Ù†Ø¬Ø²Ù‡Ø§.'); }

/* Quick mood / note */
function saveQuickMood(){
  const m = document.getElementById('quickMood').value;
  if(!m){ showToast('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø²Ø§Ø¬ Ø£ÙˆÙ„Ø§'); return; }
  const mem = { id:'m_'+Date.now(), ts:Date.now(), text:'Ø­Ø§Ù„Ø© Ù…Ø²Ø§Ø¬ÙŠØ© Ø³Ø±ÙŠØ¹Ø©', mood:m, tag:'Ù…Ø²Ø§Ø¬', daysAtSave: state.started && state.startTime ? friendlyDuration(now()-state.startTime).days : 0 };
  const arr = loadMemories(); arr.unshift(mem); saveMemories(arr); renderMemoriesList(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©');
}
function saveQuickNote(){
  const t = (document.getElementById('quickNote').value || '').trim();
  if(!t){ showToast('Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ù‚ØµÙŠØ±Ø©'); return; }
  const mem = { id:'m_'+Date.now(), ts:Date.now(), text:t, mood:'neutral', tag:'Ù…Ù„Ø§Ø­Ø¸Ø©', daysAtSave: state.started && state.startTime ? friendlyDuration(now()-state.startTime).days : 0 };
  const arr = loadMemories(); arr.unshift(mem); saveMemories(arr); renderMemoriesList(); document.getElementById('quickNote').value=''; showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
}

/* Memories (same as earlier) */
function loadMemories(){ try{ return JSON.parse(localStorage.getItem(MEM_KEY) || '[]'); }catch(e){ return []; } }
function saveMemories(arr){ try{ localStorage.setItem(MEM_KEY, JSON.stringify(arr)); }catch(e){console.error(e);} }
function addMemory(){
  const text = (document.getElementById('memText').value || '').trim();
  const mood = document.getElementById('memMood').value;
  const tag = (document.getElementById('memTag').value || '').trim();
  if(!text){ showToast('Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø°ÙƒØ±Ù‰'); return; }
  const m = { id: 'm_' + Date.now(), ts: Date.now(), text, mood, tag, daysAtSave: state.started && state.startTime ? friendlyDuration(now()-state.startTime).days : 0, type:'memory' };
  const arr = loadMemories(); arr.unshift(m);
  saveMemories(arr);
  clearMemoryForm();
  renderMemoriesList();
  showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø°ÙƒØ±Ù‰');
}
function clearMemoryForm(){ document.getElementById('memText').value=''; document.getElementById('memTag').value=''; document.getElementById('memMood').value='neutral'; }
function renderMemoriesList(){
  const list = document.getElementById('memoriesList'); if(!list) return;
  list.innerHTML='';
  const arr = loadMemories();
  if(arr.length===0){ list.innerHTML = '<div class="memory-item memory-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°ÙƒØ±ÙŠØ§Øª Ø¨Ø¹Ø¯</div>'; return; }
  arr.forEach(m=>{
    const el = document.createElement('div'); el.className='memory-item';
    const d = new Date(m.ts).toLocaleString();
    const moodClass = m.mood === 'happy' ? 'happy' : (m.mood==='sad' ? 'sad' : 'neutral');
    el.innerHTML = `<div class="memory-meta">${d} â€” Ø£ÙŠØ§Ù… Ø§Ù„Ø³ØªØ±ÙŠÙƒ ÙˆÙ‚Øª Ø§Ù„Ø­ÙØ¸: ${m.daysAtSave} <span class="mood ${moodClass}">${m.mood==='happy'?'ğŸ˜Š Ø³Ø¹ÙŠØ¯':m.mood==='sad'?'ğŸ˜” Ø­Ø²ÙŠÙ†':'ğŸ˜ Ù…Ø­Ø§ÙŠØ¯'}</span> ${m.tag?(' Â· '+m.tag):''}</div>
      <div class="memory-text">${escapeHtml(m.text)}</div>
      <div class="mem-actions">
        <button class="btn btn-ghost" onclick="editMemory('${m.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-ghost" onclick="deleteMemory('${m.id}')">Ø­Ø°Ù</button>
      </div>`;
    list.appendChild(el);
  });
}
function deleteMemory(id){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø°ÙƒØ±Ù‰ØŸ')) return; let arr = loadMemories(); arr = arr.filter(x=>x.id!==id); saveMemories(arr); renderMemoriesList(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); }
function editMemory(id){
  const arr = loadMemories(); const m = arr.find(x=>x.id===id); if(!m) return;
  document.getElementById('memText').value = m.text;
  document.getElementById('memTag').value = m.tag || '';
  document.getElementById('memMood').value = m.mood || 'neutral';
  deleteMemory(id);
  showToast('Ù‚Ù… Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸ â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø°ÙƒØ±Ù‰');
}
function createMomentMemory(){ const note = prompt('Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ø±ÙŠØ¹Ø© (Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø®Ù„Ø§Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©):',''); if(note===null || note.trim()==='') return; sessionStorage.setItem('cleanmind_moment_note', JSON.stringify({ts:Date.now(), text:note.trim(), days: state.started && state.startTime ? friendlyDuration(now()-state.startTime).days : 0})); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© (Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)'); renderMomentMemory(); }
function renderMomentMemory(){ const raw = sessionStorage.getItem('cleanmind_moment_note'); if(!raw) return; try{ const m = JSON.parse(raw); const list = document.getElementById('memoriesList'); if(list){ const tmp = document.createElement('div'); tmp.className='memory-item'; tmp.innerHTML = `<div class="memory-meta">Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ø­Ø¸ÙŠØ© â€” ${new Date(m.ts).toLocaleTimeString()} Â· Ø£ÙŠØ§Ù…: ${m.days}</div><div class="memory-text">${escapeHtml(m.text)}</div><div style="margin-top:8px"><button class="btn btn-ghost" onclick="saveMomentToMemories()">Ø­ÙØ¸ ÙƒØ°ÙƒØ±Ù‰ Ø¯Ø§Ø¦Ù…Ø©</button></div>`; list.insertBefore(tmp, list.firstChild); } }catch(e){} }
function saveMomentToMemories(){ const raw = sessionStorage.getItem('cleanmind_moment_note'); if(!raw) return; try{ const m = JSON.parse(raw); const mem = { id:'m_'+Date.now(), ts:m.ts, text:m.text, mood:'neutral', tag:'Ù„Ø­Ø¸ÙŠØ©', daysAtSave:m.days, type:'memory' }; const arr = loadMemories(); arr.unshift(mem); saveMemories(arr); sessionStorage.removeItem('cleanmind_moment_note'); renderMemoriesList(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙƒÙ…Ø°ÙƒØ±Ø©'); }catch(e){} }
function exportMemories(){ const arr = loadMemories(); const data = JSON.stringify(arr, null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'cleanmind-memories.json'; a.click(); setTimeout(()=> URL.revokeObjectURL(url), 5000); showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ØªØµØ¯ÙŠØ±'); }
function importMemories(){ const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = e=>{ const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ev=>{ try{ const parsed = JSON.parse(ev.target.result); if(!Array.isArray(parsed)) { alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); return; } if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø§Ù„ÙŠØŸ (Ù„Ù† ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø­Ø§Ø¶Ø±)')) return; const arr = loadMemories(); const merged = parsed.concat(arr); saveMemories(merged); renderMemoriesList(); showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª'); }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù'); console.error(err); } }; reader.readAsText(f); }; input.click(); }
function clearAllMemories(){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø°ÙƒØ±ÙŠØ§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')) return; saveMemories([]); renderMemoriesList(); showToast('ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª'); }

/* Ask-Coach (keyword) */
function askCoach(){
  const q = (document.getElementById('qaInput').value || '').trim(); if(!q){ showToast('Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„ Ø£ÙˆÙ„Ù‹Ø§'); return; }
  const mem = { id:'q_'+Date.now(), ts:Date.now(), text:q, mood:'neutral', tag:'Ø³Ø¤Ø§Ù„', daysAtSave: state.started ? friendlyDuration(now()-state.startTime).days : 0, type:'question' };
  const arr = loadMemories(); arr.unshift(mem); saveMemories(arr); renderMemoriesList();

  const lower = q.toLowerCase();
  let resp = '';
  if(lower.includes('ÙƒÙŠÙ') || lower.includes('Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„') || lower.includes('ÙƒÙŠÙ Ø£ØªØ¹Ø§Ù…Ù„')){
    resp = 'Ù†ØµÙŠØ­ØªÙŠ: ØºÙŠÙ‘Ø± Ø§Ù„Ø¨ÙŠØ¦Ø© â€” Ø§Ø®Ø±Ø¬ Ù„Ù„Ù…Ø´ÙŠØŒ Ø§Ø´Ø±Ø¨ Ù…Ø§Ø¡ØŒ Ø§ÙƒØªØ¨ Ù…Ù‡Ù…Ø© Ù‚ØµÙŠØ±Ø©ØŒ ÙˆØ§Ø¨Ø¯Ø£ Ù†Ø´Ø§Ø· Ø¨Ø¯ÙŠÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚.';
  } else if(lower.includes('Ù„Ù…Ø§Ø°Ø§') || lower.includes('Ø³Ø¨Ø¨')){
    resp = 'Ø§Ù„Ø¹Ø§Ø¯Ø© Ù‚Ø¯ ØªÙƒÙˆÙ† Ø±Ø¯ ÙØ¹Ù„ Ù„Ù…Ù„Ù„ Ø£Ùˆ ØªÙˆØªØ±. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¨Ø¨ ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ®Ø·ÙŠØ·.';
  } else if(lower.includes('Ø§Ø³ØªØ¹Ø§Ø¯Ø©') || lower.includes('Ø§Ø³ØªØ±Ø¬Ø§Ø¹')){
    resp = 'Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ØªØ­ØªØ§Ø¬ Ø´Ø±ÙˆØ· (Ø§Ù†ØªØ¸Ø± + ÙØ±Øµ Ù…ØªØ§Ø­Ø©). Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø­ÙƒÙ…Ø©.';
  } else if(lower.includes('Ù†ØµÙŠØ­Ø©') || lower.includes('Ù…Ø³Ø§Ø¹Ø¯Ø©')){
    resp = 'Ø§Ø¨Ø¯Ø£ Ø¨Ø®Ø·ÙˆØ§Øª ØµØºÙŠØ±Ø©ØŒ Ø§Ø·Ù„Ø¨ Ø¯Ø¹Ù…ØŒ ÙˆØ³Ø¬Ù„ ØªÙ‚Ø¯Ù…Ùƒ. ÙƒÙ„ ÙŠÙˆÙ… ØµØºÙŠØ± Ø¥Ù†Ø¬Ø§Ø².';
  } else {
    resp = 'Ø³Ø¤Ø§Ù„Ùƒ ØªÙ… Ø­ÙØ¸Ù‡ â€” Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©: Ø¬Ø±Ù‘Ø¨ ØªØ¯ÙˆÙŠÙ† Ø§Ù„Ù…Ø§Ø­Ø¸Ø© ÙˆÙ…Ø§ Ø´Ø¹Ø±Øª Ø¨Ù‡ Ø«Ù… Ø§ØªØ¨Ø¹ Ø®Ø·ÙˆØ© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚.';
  }

  document.getElementById('qaResponse').textContent = resp;
  document.getElementById('qaInput').value = '';
  showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ£Ø¹Ø·ÙŠØª Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©');
}

/* Escape helper */
function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Render functions */
function renderXP(){
  const meta = document.getElementById('xpMeta');
  const fill = document.getElementById('xpFill');
  const xpNeeded = 100;
  state.level = Math.max(1, Math.floor((state.xp||0)/xpNeeded) + 1);
  const xpProgress = (state.xp||0) % xpNeeded;
  const pct = (xpProgress / xpNeeded) * 100;
  meta.textContent = `XP: ${state.xp || 0} â€¢ Ù…Ø³ØªÙˆÙ‰ ${state.level}`;
  fill.style.width = pct + '%';
}
function renderStats(){
  document.getElementById('daysDisplay').textContent = state.started && state.startTime ? friendlyDuration((state.paused?state.pauseTime:now()) - state.startTime).days : 0;
  document.getElementById('timeDisplay').textContent = state.started && state.startTime ? (()=>{const d=friendlyDuration((state.paused?state.pauseTime:now())-state.startTime); return `${d.days} ÙŠÙˆÙ… â€¢ ${String(d.hours).padStart(2,'0')}:${String(d.minutes).padStart(2,'0')}:${String(d.seconds).padStart(2,'0')}`} )() : 'Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯';
  document.getElementById('statCurrent').textContent = state.started ? friendlyDuration((state.paused?state.pauseTime:now()) - state.startTime).days : 0;
  document.getElementById('statBest').textContent = state.bestStreakDays || 0;
  document.getElementById('statTotal').textContent = (state.totalDaysAccum || 0) + (state.started ? friendlyDuration((state.paused?state.pauseTime:now()) - state.startTime).days : 0);
  document.getElementById('statRelapses').textContent = state.relapseCount || 0;
  document.getElementById('recoveriesLeft').textContent = state.recoveriesLeft || 0;
  updateRestoreUI();
}
function updateHeaderName(){
  const headerName = document.getElementById('headerName');
  const headerTitle = document.getElementById('headerTitle');
  headerName.textContent = state.userName ? state.userName : 'Ø¨Ùƒ';
  const days = state.started && state.startTime ? friendlyDuration((state.paused?state.pauseTime:now()) - state.startTime).days : 0;
  const r = getRankByDays(state.bestStreakDays || days);
  headerTitle.textContent = r ? 'Â· ' + r.title : '';
  document.getElementById('welcomeTitle').textContent = state.userName ? `Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙŠØ§ ${state.userName}` : 'Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Clean Mind';
}
function renderBadges(){
  const bl = document.getElementById('badgeList'); bl.innerHTML = '';
  (state.badges || []).forEach(bid=>{
    const badge = document.createElement('div'); badge.className='badge earned';
    const found = {b_day3:'Ø¨Ø±ÙˆÙ†Ø²ÙŠ â€” 3 Ø£ÙŠØ§Ù…', b_day7:'ÙØ¶ÙŠ â€” 7 Ø£ÙŠØ§Ù…', b_day30:'Ø¨Ù„Ø§Ø·ÙŠÙ†ÙŠ â€” 30 ÙŠÙˆÙ…', b_day100:'Ø£Ø³Ø·ÙˆØ±ÙŠ â€” 100 ÙŠÙˆÙ…'}[bid] || 'ÙˆØ³Ø§Ù…';
    badge.textContent = found;
    bl.appendChild(badge);
  });
}
function renderRanks(){
  const grid = document.getElementById('ranksGrid');
  const currentRankBox = document.getElementById('currentRankBox');
  grid.innerHTML = ''; currentRankBox.innerHTML = '';
  const days = state.started ? friendlyDuration((state.paused?state.pauseTime:now()) - state.startTime).days : 0;
  const currentRank = getRankByDays(days);
  currentRankBox.innerHTML = `<div style="padding:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:10px"><div style="font-size:14px;color:var(--muted)">Ù„Ù‚Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</div><div style="font-weight:800;font-size:18px;margin-top:6px">${currentRank.title}</div><div style="color:var(--muted);margin-top:6px">${currentRank.desc}</div></div>`;
  RANKS.forEach(r=>{
    const card = document.createElement('div'); card.className='rank-card'; if(r.id===currentRank.id) card.classList.add('highlight');
    card.innerHTML = `<div style="font-weight:800">${r.title}</div><div style="color:var(--muted);margin-top:6px">Ù…Ù† ${r.min} ÙŠÙˆÙ…</div><div style="margin-top:6px;color:var(--muted)">${r.desc}</div>`;
    grid.appendChild(card);
  });
}

/* Tabs */
let currentTab = 'challenge';
function showTab(tab){
  currentTab = tab;
  ['challenge','ranks','stats','memories','settings','guide'].forEach(id=>{
    const el = document.getElementById(id); if(!el) return; el.style.display = (id===tab)?'block':'none';
  });
  ['navChallenge','navRanks','navStats','navMemories','navSettings','navGuide'].forEach(id=>{
    const btn = document.getElementById(id); if(!btn) return; const map = {navChallenge:'challenge', navRanks:'ranks', navStats:'stats', navMemories:'memories', navSettings:'settings', navGuide:'guide'}; btn.classList.toggle('active', map[id]===tab);
  });
  renderAll();
}

/* Visit popup */
function showVisitPopupIfNeeded(){ try{ const val = localStorage.getItem(VISIT_KEY); if(val === 'hidden') return; }catch(e){} const modal = document.getElementById('visitModal'); modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
function hideVisitPopup(){ const modal=document.getElementById('visitModal'); modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
function skipVisitPopup(){ hideVisitPopup(); showTab('challenge'); }
function dontShowPopupAgain(){ localStorage.setItem(VISIT_KEY,'hidden'); hideVisitPopup(); showTab('challenge'); }
function saveNameFromPopup(){ const v = (document.getElementById('nameField').value || '').trim(); if(!v){ showToast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø¹Ù„Ø´Ø§Ù† Ø£Ø­ÙØ¸Ù‡'); return; } state.userName = v; saveNameLocal(v); pushLog('set_name', v); hideVisitPopup(); showTab('guide'); renderAll(); }

/* Guide quiz */
const guideQuestions = [
  {q: "Ø¥ÙŠÙ‡ Ø£ÙƒØªØ± Ø­Ø§Ø¬Ø© Ø¨ØªØ®ÙˆÙÙƒ Ø¥Ù†Ùƒ ØªØ®Ø³Ø± Ø§Ù„ØªØ­Ø¯ÙŠØŸ", a:["Ø§Ù„Ù†Ø¯Ù…","Ø¥Ù†ÙŠ Ø£Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±","Ø®Ø³Ø§Ø±Ø© Ø«Ù‚ØªÙŠ Ø¨Ù†ÙØ³ÙŠ"], m:["ÙƒÙ„ Ø®Ø·ÙˆØ© Ø¨ØªÙ‚ÙˆÙ‘ÙŠÙƒ.","Ø§Ù„Ø¨Ø¯Ø§ÙŠØ§Øª Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø·Ø±ÙŠÙ‚.","Ø«Ù‚ØªÙƒ Ø¨ØªØ²ÙŠØ¯ ÙƒÙ„ Ù…Ø±Ø© ØªÙ‚ÙˆÙ… ÙÙŠÙ‡Ø§."]},
  {q: "Ø¥ÙŠÙ‡ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù„ÙŠ Ø®Ù„Ø§Ùƒ ØªØ¨Ø¯Ø£ØŸ", a:["Ø£Ø«Ø¨Øª Ù„Ù†ÙØ³ÙŠ","Ø£ØªØ­Ø³Ù†","Ø£ØªØ®Ù„Øµ Ù…Ù† Ø¹Ø§Ø¯Ø©"], m:["Ø§Ù„Ù†ÙŠØ© Ø¯ÙŠ Ù‚ÙˆØ© Ø­Ù‚ÙŠÙ‚ÙŠØ©.","Ø§Ù„ØªØ­Ø³Ù† Ø±Ø­Ù„Ø© Ù…Ø³ØªÙ…Ø±Ø©.","ÙƒÙ„ ÙŠÙˆÙ… ØµØºÙŠØ± Ø¥Ù†Ø¬Ø§Ø² ÙƒØ¨ÙŠØ±."]},
  {q: "Ø¥ÙŠÙ‡ Ø¥Ø­Ø³Ø§Ø³Ùƒ Ù„Ù…Ø§ Ø¨ØªÙƒØ³Ø¨ Ù†ÙØ³Ùƒ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ØŸ", a:["ÙØ®Ø±","Ø±Ø§Ø­Ø©","Ù‚ÙˆØ©"], m:["Ø§Ù„ÙØ®Ø± Ù‡Ùˆ ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±.","Ø§Ù„Ø±Ø§Ø­Ø© Ù…ÙƒØ§ÙØ£Ø© Ø¬Ø¯ÙŠØ±Ø©.","Ø§Ù„Ù‚ÙˆØ© Ø¯ÙŠ Ø¨ØªÙƒØ¨Ø± Ù…Ø¹ ÙƒÙ„ ÙŠÙˆÙ…."]}
];
function startGuideQuiz(){
  document.getElementById('guideQuizArea').style.display='block';
  loadGuideQuestion();
}
function loadGuideQuestion(){
  const idx = Math.floor(Math.random()*guideQuestions.length); const q = guideQuestions[idx];
  document.getElementById('gQuestion').textContent = q.q;
  const answers = document.getElementById('gAnswers'); answers.innerHTML='';
  document.getElementById('gMessage').textContent='';
  q.a.forEach((ans,i)=>{ const btn = document.createElement('button'); btn.className='btn btn-ghost'; btn.textContent = ans; btn.onclick = ()=> { document.getElementById('gMessage').textContent = q.m[i]; }; answers.appendChild(btn); });
}
function finishGuide(){ showToast('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ â€” Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠ!'); showTab('challenge'); }

/* Celebration */
function showCelebration(title, text){
  document.getElementById('celebrationTitle').textContent = title || 'ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!';
  document.getElementById('celebrationText').textContent = text || '';
  const modal=document.getElementById('celebrationModal'); modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
  spawnConfetti(90);
  setTimeout(()=> closeCelebration(), 5500);
}
function closeCelebration(){ const m=document.getElementById('celebrationModal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }

/* Settings: theme */
function setTheme(t){
  if(t==='pink'){ document.documentElement.style.setProperty('--fire1','#ff80ab'); document.documentElement.style.setProperty('--fire2','#ff3d9a'); showToast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø³Ù‚ Ù„Ù„ÙˆØ±Ø¯ÙŠ'); }
  else if(t==='dark'){ document.documentElement.style.setProperty('--fire1','#2e2e3a'); document.documentElement.style.setProperty('--fire2','#44475a'); showToast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø³Ù‚ Ù„Ù„Ø¯Ø§ÙƒÙ†'); }
  else { document.documentElement.style.setProperty('--fire1','#ff5f3d'); document.documentElement.style.setProperty('--fire2','#ff9a3d'); showToast('ØªÙ… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù†Ø³Ù‚ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ'); }
}

/* Logo upload handling */
const logoUploadEl = document.getElementById('logoUpload');
const logoPreview = document.getElementById('logoPreview');
const logoEl = document.getElementById('logoEl');

logoUploadEl.addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ev=>{
    // show preview
    logoPreview.style.backgroundImage = `url(${ev.target.result})`;
    logoPreview.textContent = '';
    // keep the data in a temp place until user clicks apply
    logoPreview.dataset.pending = ev.target.result;
    showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø¶ØºØ· "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø¹Ø§Ø±")');
  };
  r.readAsDataURL(f);
});

function applyUploadedLogo(){
  const data = logoPreview.dataset.pending;
  if(!data){ showToast('Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ù‹Ø§'); return; }
  try{ localStorage.setItem(LOGO_KEY, data); }catch(e){ console.error(e); }
  setLogoFromStorage();
  showToast('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø¹Ø§Ø±');
}
function setLogoFromStorage(){
  const v = localStorage.getItem(LOGO_KEY);
  if(v){ logoEl.style.backgroundImage = `url(${v})`; logoEl.textContent=''; logoPreview.style.backgroundImage = `url(${v})`; logoPreview.textContent=''; }
  else { logoEl.style.backgroundImage = ''; logoEl.textContent = 'CM'; logoPreview.style.backgroundImage=''; logoPreview.textContent='CM'; }
}
function removeLogo(){ localStorage.removeItem(LOGO_KEY); logoPreview.dataset.pending=''; setLogoFromStorage(); showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ'); }

/* Export/Import full data */
function exportAllData(){
  const payload = { state, memories: loadMemories(), logo: localStorage.getItem(LOGO_KEY) || null, name: localStorage.getItem(NAME_KEY) || '' };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = 'cleanmind-full-export.json'; a.click(); setTimeout(()=> URL.revokeObjectURL(url), 5000);
  showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ØªØµØ¯ÙŠØ±');
}
function importAllData(){
  const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = e=>{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = ev=>{
      try{
        const parsed = JSON.parse(ev.target.result);
        if(!parsed.state || !parsed.memories){ if(!confirm('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ¨Ø¯Ùˆ Ù…Ø·Ø§Ø¨Ù‚Ø§Ù‹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ â€” Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) return; }
        if(parsed.state) { state = {...DEFAULT, ...parsed.state}; saveState(); }
        if(Array.isArray(parsed.memories)) { saveMemories(parsed.memories); }
        if(parsed.logo) try{ localStorage.setItem(LOGO_KEY, parsed.logo); }catch(e){}
        if(parsed.name) saveNameLocal(parsed.name);
        setLogoFromStorage();
        renderAll();
        showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©)');
      }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù'); console.error(err); }
    }; r.readAsText(f);
  }; input.click();
}

/* Reset all */
function resetAll(){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„ Ø´ÙŠØ¡ (Ø³ÙŠÙ…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§)ØŸ')) return; localStorage.removeItem(KEY); localStorage.removeItem(NAME_KEY); localStorage.removeItem(MEM_KEY); localStorage.removeItem(LOGO_KEY); state = {...DEFAULT}; state.userName=''; saveState(); renderAll(); setLogoFromStorage(); showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·'); }

/* Misc: logs */
function pushLog(action, meta=''){ state.logs = state.logs || []; state.logs.unshift({ts:Date.now(), action, meta}); if(state.logs.length>400) state.logs.length=400; saveState(); }

/* Render everything */
function renderAll(){ updateHeaderName(); renderXP(); renderStats(); renderBadges(); renderMemoriesList(); renderRanks(); setLogoFromStorage(); }

/* detect clock tamper (basic) */
function detectClockTamper(){
  const last = state.lastTick || Date.now();
  const nowTs = Date.now();
  if(nowTs + 5000 < last){
    showToast('ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† ØªØºÙŠÙŠØ± ÙÙŠ Ø³Ø§Ø¹Ø© Ø§Ù„Ø¬Ù‡Ø§Ø². Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù…ÙˆÙ‚ÙˆÙ.', false);
    state.paused = true;
    state.pauseTime = nowTs;
    saveState();
    renderAll();
  }
}

/* interval tick (updates timer + milestones + notifications) */
setInterval(()=>{
  detectClockTamper();
  // update render
  renderAll();
  checkMilestones();
  scheduleNotificationsTick();
}, 1000);

/* Notifications schedule simple */
function scheduleNotificationsTick(){
  if(!state.notifEnabled) return;
  const [h,m] = (state.notifTime || '08:00').split(':').map(x=>parseInt(x,10));
  const nowD = new Date();
  if(nowD.getHours()===h && nowD.getMinutes()===m){
    const key = `${nowD.getFullYear()}-${nowD.getMonth()+1}-${nowD.getDate()}_${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    if(state.lastNotifKey !== key){
      if(Notification.permission==='granted') new Notification('Clean Mind', {body:'ØªØ°ÙƒÙŠØ±: Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø°Ù‡Ù†Ùƒ Ø§Ù„ÙŠÙˆÙ… -- Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø© Ø§Ù„Ø¢Ù†.'});
      state.lastNotifKey = key; saveState();
    }
  }
}

/* INIT */
document.addEventListener('DOMContentLoaded', ()=>{
  renderAll();
  // show visit popup if no name
  if(!state.userName) showVisitPopupIfNeeded();
  // set logo preview from storage
  setLogoFromStorage();
  // small intro celebration if appropriate
  if(state.bestStreakDays && state.bestStreakDays >= 7){
    setTimeout(()=>{ spawnConfetti(70); showCelebration('Ø£Ø³Ø¨ÙˆØ¹ Ø±Ø§Ø¦Ø¹!','ØªÙ‚Ø¯Ù… Ù…Ø³ØªÙ…Ø± â€” Ø£Ø­Ø³Ù†Øª!'); }, 800);
  }
});

/* Expose some helpers for dev console */
window._cm = { state, renderAll, loadMemories, saveMemories, addMemory, deleteMemory, exportAllData };

</script>
</body>
</html>